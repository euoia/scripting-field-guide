<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shell Field Guide</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Raimon Grau" />
<meta name="keywords" content="bash zsh shell" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Shell Field Guide</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org032e6ff">1. Introduction</a></li>
<li><a href="#org24c7002">2. shell</a></li>
<li><a href="#org86b29f7">3. Level</a></li>
<li><a href="#org9a42cf6">4. bash</a>
<ul>
<li><a href="#org908abd7">4.1. Use Shellcheck</a></li>
<li><a href="#orgaa2dd9e">4.2. use [[</a></li>
<li><a href="#org90f94a3">4.3. eval?</a></li>
</ul>
</li>
<li><a href="#org8ade7b2">5. Basics</a>
<ul>
<li><a href="#org006284d">5.1. Overview</a></li>
<li><a href="#org12cd846">5.2. Booleans and Conditionals</a></li>
<li><a href="#org06a189c">5.3. Functions</a></li>
<li><a href="#orgbbd6f61">5.4. Variables</a></li>
<li><a href="#org77170ff">5.5. Interpolation</a></li>
<li><a href="#org0b0ac10">5.6. dispatch functions using args</a></li>
<li><a href="#org579f5ea">5.7. command_not_found_handle</a></li>
<li><a href="#org397a06c">5.8. Return Values for Conditionals</a></li>
<li><a href="#org951b29c">5.9. Do work on loop conditions</a></li>
<li><a href="#org810d4e7">5.10. One Branch Conditionals</a></li>
</ul>
</li>
<li><a href="#orgf239c68">6. interactive</a>
<ul>
<li><a href="#org4c30eb6">6.1. Save your small scripts</a></li>
<li><a href="#org6e313ad">6.2. Increased Interactivity</a></li>
<li><a href="#orgb55e48c">6.3. Aliases</a></li>
<li><a href="#org5e7aa56">6.4. functions can generate aliases</a></li>
<li><a href="#orge3d1992">6.5. Override (advise?) common functions</a></li>
</ul>
</li>
<li><a href="#org53bbe21">7. zsh</a>
<ul>
<li><a href="#org54c6b5b">7.1. examples of global aliases</a></li>
<li><a href="#org20a3ba2">7.2. pass commands around</a></li>
<li><a href="#orgb9dcaf1">7.3. suffix aliases don't have to match a filename</a></li>
<li><a href="#org5ee6ad2">7.4. noglob</a></li>
<li><a href="#org13ee665">7.5. make noglob 'transparent' to bash</a></li>
</ul>
</li>
<li><a href="#orgc54939f">8. debugging</a>
<ul>
<li><a href="#org9f1c731">8.1. adding <code>bash</code> to a script to debug</a></li>
<li><a href="#org73ed1a7">8.2. DRY_RUN</a></li>
</ul>
</li>
<li><a href="#org1a58085">9. patterns</a>
<ul>
<li><a href="#orgce53b11">9.1. undestand &lt;(foo) and &gt;(foo)</a></li>
<li><a href="#org2502bab">9.2. use xargs</a></li>
<li><a href="#org12728a1">9.3. use GNU Parallel</a></li>
<li><a href="#org01c8db8">9.4. append options in an array during the logic of the program</a></li>
<li><a href="#org8aa2dc9">9.5. trap</a></li>
<li><a href="#org7ae5738">9.6. debug by introducing a 'bash'</a></li>
<li><a href="#orgdd73289">9.7. debug with set -xa</a></li>
<li><a href="#org7d31c88">9.8. structure the app like a normal app</a>
<ul>
<li><a href="#org7073c1c">9.8.1. Fail Fast</a></li>
<li><a href="#org5dace12">9.8.2. Template</a></li>
</ul>
</li>
<li><a href="#org2ee66c1">9.9. make steps of the process composable</a></li>
<li><a href="#org158184e">9.10. use $@ when you can</a></li>
<li><a href="#orgf923348">9.11. source files</a></li>
<li><a href="#orgf3db497">9.12. Dots and colons allowed in function names!</a></li>
<li><a href="#org5860b71">9.13. Use Scripts as a Libs</a></li>
<li><a href="#orgf50726b">9.14. Use tempfiles everywhere</a></li>
<li><a href="#orgd513113">9.15. Use tempdirs everywhere</a></li>
<li><a href="#org265026e">9.16. Cleanup tasks with trap</a></li>
<li><a href="#orge052379">9.17. array of callbacks on_exit</a></li>
<li><a href="#org4ee1e05">9.18. pass flags as a splatted array</a></li>
<li><a href="#org061229b">9.19. explore what passes through a pipe with</a></li>
<li><a href="#org87b84a1">9.20. inherit_errcode</a></li>
<li><a href="#org225c52f">9.21. redirects</a></li>
<li><a href="#orgf777f16">9.22. pushd/popd</a></li>
<li><a href="#org02052a9">9.23. wrap functions</a></li>
</ul>
</li>
<li><a href="#orga3f2e57">10. links</a></li>
<li><a href="#orge01154a">11. from shell to lisp and everything in between</a></li>
<li><a href="#orgba41eed">12. make scripts compatible between them</a>
<ul>
<li><a href="#orge574e3f">12.1. create scripts that replace shell commands and do the same.</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org032e6ff" class="outline-2">
<h2 id="org032e6ff"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This booklet is intended to be a catalog of tricks and techniques
you may want to use if you're doing some sort of complex
scripting. I'll try to keep the rethoric to the very minimal because
that way you can enjoy the content in less time.
</p>

<p>
The git repo is at <a href="https://github.com/kidd/scripting-field-guide/">https://github.com/kidd/scripting-field-guide/</a>
and both contents, order and wording are WIP. Any feedback is
greatly appreciated. It's not any kind of official doc, and in fact
I'm learning as I go. Ijust write MY current "state of the
art". I'll be updating the contents with the very very useful info
in <a href="https://news.ycombinator.com/item?id=24401085">https://news.ycombinator.com/item?id=24401085</a> 's comments.
</p>

<p>
You probably have some amount of sh/bash/zsh in your stack that
probably started as 1 off scripts, and probably later on started
growing and being copypasted everywhere in your pipelines, or your
coworkers use for their own use (with some variations), etc. Those
scripts are very difficult to kill and they have a very high
mutation rate.
</p>
</div>
</div>
<div id="outline-container-org24c7002" class="outline-2">
<h2 id="org24c7002"><span class="section-number-2">2</span> shell</h2>
<div class="outline-text-2" id="text-2">
<p>
No matter if you use Linux, Mac, or Windows, you should be living
most of the time in a shell to enjoy the content shown here. Some
value comes from the automated scripts, and some comes from the
daily usage and refinement of your helper functions, aliases,
etc. in interactive mode.
</p>

<p>
In general the examples here are ment to run in Bash or Zsh, which
are compatible for the most part.
</p>
</div>
</div>
<div id="outline-container-org86b29f7" class="outline-2">
<h2 id="org86b29f7"><span class="section-number-2">3</span> Level</h2>
<div class="outline-text-2" id="text-3">
<p>
These examples are based on non-trivial real world code I've written
that I haven't seen applied in many places over the net. Some of the
snippets are stolen from public repos and some important stuff might
be missing if I don't feel I have anything to add to the generally
available info around.
</p>
</div>
</div>
<div id="outline-container-org9a42cf6" class="outline-2">
<h2 id="org9a42cf6"><span class="section-number-2">4</span> bash</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org908abd7" class="outline-3">
<h3 id="org908abd7"><span class="section-number-3">4.1</span> Use Shellcheck</h3>
<div class="outline-text-3" id="text-4-1">
<p>
First, let's get that out of the way. This is low hanging
fruit. And you will get the most of this booklet by following it.
</p>

<p>
A lot of the most common errors we usually make are well known
ones. And in fact, we all usually fail in similar ways. Bash is
known for being error prone when dealing with testing variable
values, string operations, or flaky subshells and pipes.
</p>

<p>
Installing <a href="https://www.shellcheck.net/">shellcheck</a> will flag you many of those ticking bombs.
</p>

<p>
No matter which editor you are using, but you should be able to
install a plugin to do automatic checks while you're editing.
</p>

<p>
In emacs' case, the package is called <a href="https://github.com/federicotdn/flymake-shellcheck">flymake-shellcheck</a>, and a
quick configuration for it is:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(use-package flymake-shellcheck
  <span style="font-weight: bold;">:ensure</span> t
  <span style="font-weight: bold;">:commands</span> flymake-shellcheck-load
  <span style="font-weight: bold;">:init</span>
  (add-hook 'sh-mode-hook 'flymake-shellcheck-load))
</pre>
</div>

<p>
Shellcheck is available on most distros, so it's just an <code>apt</code>,
<code>brew</code>, or <code>nix-env</code> away.
</p>
</div>
</div>

<div id="outline-container-orgaa2dd9e" class="outline-3">
<h3 id="orgaa2dd9e"><span class="section-number-3">4.2</span> use [[</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Unless you want your script to be POSIX compliant, use <code>[[</code> instead
of <code>[</code>. <code>[</code> is a regular command. It's like <code>ls</code>, or <code>true</code>. You can
check it by searching for a file named <code>[</code> in your path.
</p>

<p>
Being a normal command it always evaluates its params, like a
regular function. On the other hand though, <code>[[</code> is a special bash
operator, and it evaluates the parameters lazily.
</p>

<div class="org-src-container">
<pre class="src src-bash">
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">[[ does lazy evaluation:</span>
[[ a = b &amp;&amp; $(<span style="font-weight: bold;">echo</span> foo &gt;&amp;2) ]]

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">[ does not:</span>
[ a = b -a <span style="font-style: italic;">"$(echo foo &gt;&amp;2)&#8221; ]</span>
</pre>
</div>
<p>
Ref: <a href="https://lists.gnu.org/archive/html/help-bash/2014-06/msg00013.html">https://lists.gnu.org/archive/html/help-bash/2014-06/msg00013.html</a>
</p>
</div>
</div>

<div id="outline-container-org90f94a3" class="outline-3">
<h3 id="org90f94a3"><span class="section-number-3">4.3</span> eval?</h3>
<div class="outline-text-3" id="text-4-3">
<p>
When you have mostly small functions that are mostly pure, you
compose them like you'd do in any other language.
</p>

<p>
In the following snippet, we are in a release script. Some step
builds a package inside an image, another step tests a package
already built.
</p>

<p>
A nice way to build ubuntus, for example, is to add an ARG to the
Dockerfile so we can build several ubuntu versions using the same
file.
</p>

<p>
It'd look something like this:
</p>
<div class="org-src-container">
<pre class="src src-Dockerfile">ARG VERSION
FROM ubuntu:$VERSION

RUN apt-get ...
...
</pre>
</div>

<p>
We build that image and do all the building inside it, mounting a
volume shared with our host, so we can extract our <code>.deb</code> file
easily.
</p>

<p>
After that, you probably want to do some smoke tests on the
package, so the idea would be to install the <code>.deb</code> file in a fresh
ubuntu image.
</p>

<p>
Let's pick the same base image we picked to build the package.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">evaluate the string "centos:$VERSION" (that comes from</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">centos/Dockerfile) in the current scope</span>
local <span style="font-weight: bold; font-style: italic;">VERSION</span>=$(get_version $<span style="font-weight: bold; font-style: italic;">DISTRO</span>)
run_tests <span style="font-style: italic;">"$PACKAGE_PATH"</span> <span style="font-style: italic;">"$(eval echo $(awk '/^FROM /{print $2; exit}' $LOCAL_PATH/$(get_dockerfile_for $DISTRO)))"</span>
</pre>
</div>

<p>
The usage of eval is there to interpolate the string that we get
from the <code>FROM</code> in the current environment.
</p>

<p>
WARNING: You know, anything that uses <code>eval</code> is dangerous per
se. Do not use it unless you know very well what you're doing AND
the input is 100% under your control. Usually, more restricted
commands can achieve what you want to do. In this particular case,
you could use <code>envsubst</code>, or just manually replace <code>$\{?VERSION\}?</code>
in a sed.
</p>

<div class="org-src-container">
<pre class="src src-bash">test_release <span style="font-style: italic;">"$PACKAGE_PATH"</span> $(awk <span style="font-style: italic;">'/^FROM /{print $2; exit}'</span> $<span style="font-weight: bold; font-style: italic;">LOCAL_PATH</span>/$(get_dockerfile_for $<span style="font-weight: bold; font-style: italic;">DISTRO</span>) | sed -e <span style="font-style: italic;">"s/\$VERSION/$VERSION/"</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8ade7b2" class="outline-2">
<h2 id="org8ade7b2"><span class="section-number-2">5</span> Basics</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org006284d" class="outline-3">
<h3 id="org006284d"><span class="section-number-3">5.1</span> Overview</h3>
<div class="outline-text-3" id="text-5-1">
<p>
In this section, we're covering the parts of the basics that are
not so basic after all, or that are more unique in shellscripting
languages.
</p>
</div>
</div>

<div id="outline-container-org12cd846" class="outline-3">
<h3 id="org12cd846"><span class="section-number-3">5.2</span> Booleans and Conditionals</h3>
<div class="outline-text-3" id="text-5-2">
<p>
In any shell, <code>foo &amp;&amp; bar</code> will execute <code>bar</code> only if <code>foo</code>
succeeded. That means that <code>foo</code> returned 0. That means that to &amp;&amp;
(which you read like "and"), 0 is true. so yes. 0 is true, and
other values are false.
</p>
</div>
</div>

<div id="outline-container-org06a189c" class="outline-3">
<h3 id="org06a189c"><span class="section-number-3">5.3</span> Functions</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Functions are functions. They receive arguments, and they return a
value.
</p>

<p>
The special thing about functions in shell is that they also can use
the file descriptors of the process. That means that they "inherit"
STDIN, STDOUT, STDERR (and maybe more).
</p>

<p>
Use them.
</p>

<p>
Another point is that function names can be passed as parameters,
because they are passed as strings, but you can call them inside as
functions again.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">f</span>() {
  $<span style="font-weight: bold; font-style: italic;">1</span> hi
}

f echo
f touch <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">will create a file 'hi'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbbd6f61" class="outline-3">
<h3 id="orgbbd6f61"><span class="section-number-3">5.4</span> Variables</h3>
<div class="outline-text-3" id="text-5-4">
<p>
By default variables are global, to a file. No matter if you assign
them for the first time inside a function, or at the top leve.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">foo</span>=3
<span style="font-weight: bold; font-style: italic;">bar</span>=$<span style="font-weight: bold; font-style: italic;">foo</span>
<span style="font-weight: bold;">f</span>() {
  <span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">foo</span>
}
f
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">f</span>() {
  <span style="font-weight: bold; font-style: italic;">bar</span>=1
}
f
<span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">bar</span>
</pre>
</div>

<p>
You make a variable local to a function with <code>local</code>. Use it as
much as you can (kinda obvious).
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">myfun</span>() {
  local bar
  <span style="font-weight: bold; font-style: italic;">bar</span>=3
  <span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">bar</span>
}

<span style="font-weight: bold; font-style: italic;">bar</span>=4
<span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">bar</span>
myfun
<span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">bar</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org77170ff" class="outline-3">
<h3 id="org77170ff"><span class="section-number-3">5.5</span> Interpolation</h3>
<div class="outline-text-3" id="text-5-5">
<p>
We previously saw that functions can be passed around as strings,
and be called later on.
</p>

<p>
Something that might not be obvious is that the string can be
created from shorter strings, and that allows for an extra
flexibility, that comes with its own dangers, but it's a very
useful pattern to dispatch functions based on user input or
function outputs.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">l</span>=l
<span style="font-weight: bold; font-style: italic;">s</span>=s
$<span style="font-weight: bold; font-style: italic;">l</span>$<span style="font-weight: bold; font-style: italic;">s</span> .
</pre>
</div>
</div>
</div>

<div id="outline-container-org0b0ac10" class="outline-3">
<h3 id="org0b0ac10"><span class="section-number-3">5.6</span> dispatch functions using args</h3>
<div class="outline-text-3" id="text-5-6">
<p>
A nice usage of the previous technique is using user's input as a
dispatching method.
</p>

<p>
You've probably seen this pattern already:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">while</span> [[ $<span style="font-weight: bold; font-style: italic;">#</span> -gt 0 ]]; <span style="font-weight: bold;">do</span>

<span style="font-weight: bold;">case</span> $<span style="font-weight: bold; font-style: italic;">1</span><span style="font-weight: bold;"> in</span>
  foo)
    foo
    ;;
  *)
    <span style="font-weight: bold;">exit</span> 1
    ;;
<span style="font-weight: bold;">esac</span>
<span style="font-weight: bold;">shift</span>
<span style="font-weight: bold;">done</span>
</pre>
</div>

<p>
And it is useful for its own good, and flexible.
</p>

<p>
But for some simpler cases, we can dispatch based on the variable
itself:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">cmd_foo</span>() {
 do-something
}

cmd_$<span style="font-weight: bold; font-style: italic;">1</span>
</pre>
</div>

<p>
The problem with this is that in case we supply a <code>$1</code> that doesn't
map to any <code>cmd_$1</code> we'll get something like
</p>

<div class="org-src-container">
<pre class="src src-bash">bash: cmd_notexisting: command not found
</pre>
</div>
</div>
</div>

<div id="outline-container-org579f5ea" class="outline-3">
<h3 id="org579f5ea"><span class="section-number-3">5.7</span> command_not_found_handle</h3>
<div class="outline-text-3" id="text-5-7">
<p>
Here's a detail on a kinda obscure bash (only bash) feature.
</p>

<p>
You can set a hook that will be called when bash tries to run a
command and it doesn't find it.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">command_not_found_handle</span>() {
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"$1 is not a correct command. Cmds allowed:"</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"$(typeset -F | grep cmd_ | sed -e 's/.*cmd_/cmd_/')"</span>
}

<span style="font-weight: bold;">cmd_foo</span>() {
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"foo"</span>
}

<span style="font-weight: bold;">cmd_baz</span>() {
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"baz"</span>
}
cmd_bar
</pre>
</div>

<p>
you can unset the function <code>command_not_found_handle</code> to go back to
the normal behavior.
</p>
</div>
</div>


<div id="outline-container-org397a06c" class="outline-3">
<h3 id="org397a06c"><span class="section-number-3">5.8</span> Return Values for Conditionals</h3>
<div class="outline-text-3" id="text-5-8">
<p>
<code>if</code> 's conditions can be bound to the return values of
commands. That's a known thing, but lots of code you see around
rely on <code>[[]]=</code> to test the return values of commands/functions
anyway.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">if </span><span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"foo"</span> | grep <span style="font-style: italic;">"bar"</span> ; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"found!"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>

<p>
This is much clearer than
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">if</span> [[ ! -z $( <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"foo"</span> | grep <span style="font-style: italic;">"bar"</span>) ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"found!"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>

<p>
As easy and trivial as it seems, this way of thinking pushes you
forward to thinking on creating smaller functions that check the
conditions and <code>return</code> 0 or non 0. It's syntactically smaller, and
usually makes you play by the rules of the commands, more than just
finding your way around the output strings.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">if</span> less_than $<span style="font-weight: bold; font-style: italic;">package</span> <span style="font-style: italic;">"1.3.2"</span>; <span style="font-weight: bold;">then</span>
  die <span style="font-style: italic;">"can't proceed"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org951b29c" class="outline-3">
<h3 id="org951b29c"><span class="section-number-3">5.9</span> Do work on loop conditions</h3>
<div class="outline-text-3" id="text-5-9">
<p>
Although not commonly seen used (and there might be a reason for
it, who knows), <code>while</code> conditions are just plain commands, so you
can put other stuff than <code>[]</code> tests there.
</p>

<p>
Heres's an idiomatic way to iterate through all the arguments of a
function while consuming the <code>$*</code> array.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">while</span>(($<span style="font-weight: bold; font-style: italic;">#</span>)) ; <span style="font-weight: bold;">do</span>
  <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">...</span>
  <span style="font-weight: bold;">shift</span>
<span style="font-weight: bold;">done</span>
</pre>
</div>

<p>
And here's a pseudo-repl that keeps shooting one-off commands. This
will keep shooting <code>tr</code> commands to whatever strings you give it,
with the usual rlwrap goodies.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">while</span> rlwrap -o -S<span style="font-style: italic;">'&gt;&gt; '</span> tr a-z A-Z ; <span style="font-weight: bold;">do</span> :; <span style="font-weight: bold;">done</span>
</pre>
</div>

<p>
Note: <code>:</code> is a nop builtin in bash.
</p>
</div>
</div>
<div id="outline-container-org810d4e7" class="outline-3">
<h3 id="org810d4e7"><span class="section-number-3">5.10</span> One Branch Conditionals</h3>
<div class="outline-text-3" id="text-5-10">
<p>
The usual conditionals one sees everywhere look like <code>if</code>.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">if</span> [[ some-condition ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"yes"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>

<p>
This is all good and fine, but in the same vein of using the least
powerful construct for each task, it's nice to think of the one way
conditionals in the form of <code>&amp;&amp;</code> and <code>||</code> as a way to explicitly
say that we don't want to do anything else when the condition is
not met. It's a hint to the reader.
</p>

<div class="org-src-container">
<pre class="src src-bash">some-condition || {
   <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"log: warning!"</span>
}

other-condition &amp;&amp; {
   <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"log: all cool"</span>
}
</pre>
</div>

<p>
This conveys the desire of doing something <b>just</b> in one case, and
that the negation of this is not interesting at all.
</p>

<p>
There are lots of references to this, but I like this recent post
where it explains it for arrays in higher level languages like ruby:
<a href="https://jesseduffield.com/array-functions-and-the-rule-of-least-power/">https://jesseduffield.com/array-functions-and-the-rule-of-least-power/</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orgf239c68" class="outline-2">
<h2 id="orgf239c68"><span class="section-number-2">6</span> interactive</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org4c30eb6" class="outline-3">
<h3 id="org4c30eb6"><span class="section-number-3">6.1</span> Save your small scripts</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Rome wasn't built in a day, and like having a journal log, most of
the little scripts you create, once you have enough discipline will
be useful for some other cases, and your functions will be
reusable.
</p>

<p>
Save your scripts into files early on, instead of crunching
everything in the repl. learn how to use a decent editor that
shortens the feedback cycle as much as possible.
</p>
</div>
</div>

<div id="outline-container-org6e313ad" class="outline-3">
<h3 id="org6e313ad"><span class="section-number-3">6.2</span> Increased Interactivity</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Knowing your shell's shortcuts for interactive use is a must. The
same way you learned to touchtype and you learned your editor, you
should learn all the shortcuts for your shell. Here's some simple
ones.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">key</th>
<th scope="col" class="org-left">action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">ctrl-r</td>
<td class="org-left">reverse-history-search</td>
</tr>

<tr>
<td class="org-left">c-a</td>
<td class="org-left">beginning-of-line</td>
</tr>

<tr>
<td class="org-left">c-e</td>
<td class="org-left">end-of-line</td>
</tr>

<tr>
<td class="org-left">c-w</td>
<td class="org-left">delete-word-backwards</td>
</tr>

<tr>
<td class="org-left">c-k</td>
<td class="org-left">kill-line (from point to eol)</td>
</tr>

<tr>
<td class="org-left">c-p</td>
<td class="org-left">previous-line</td>
</tr>

<tr>
<td class="org-left">c-n</td>
<td class="org-left">next-line</td>
</tr>

<tr>
<td class="org-left">a-.</td>
<td class="org-left">insert last agument</td>
</tr>

<tr>
<td class="org-left">a-/</td>
<td class="org-left">dabbrev-expand</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgb55e48c" class="outline-3">
<h3 id="orgb55e48c"><span class="section-number-3">6.3</span> Aliases</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Aliases are very simple substitutions of commands for a sequence of
other commands.  Usual example is
</p>

<div class="org-src-container">
<pre class="src src-bash">alias <span style="font-weight: bold; font-style: italic;">ls</span>=<span style="font-style: italic;">'ls --auto-color'</span>
</pre>
</div>

<p>
Now let's move on to the interesting stuff.
</p>
</div>
</div>

<div id="outline-container-org5e7aa56" class="outline-3">
<h3 id="org5e7aa56"><span class="section-number-3">6.4</span> functions can generate aliases</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Aliases live in a global namespace for the shell, so no matter
where you define them, they take effect globally, possibly
overwriting older aliases with the same name.
</p>

<p>
Well, it's not lexical scope (far from it), but using aliases you
can create a string that snapshots the value you want, and capture
it to run it later.
</p>

<p>
Some fun stuff:
</p>

<ul class="org-ul">
<li>aliasgen. Create an alias for each directory in
~/workspace/. This is superceeded by <code>CDPATH</code>, but the trick is
still cool.</li>
</ul>
<div class="org-src-container">
<pre class="src src-zsh">aliasgen() {
  for i in ~/workspace/*(/) ; do
      DIR=$(basename $i) ;
       alias $DIR="cd ~/workspace/$i";
  done
}
aliasgen
</pre>
</div>

<ul class="org-ul">
<li>a make a shortcut to the current directory.</li>
</ul>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">function</span> <span style="font-weight: bold;">a</span>() { alias $<span style="font-weight: bold; font-style: italic;">1</span>=cd<span style="font-style: italic;">\ </span>$<span style="font-weight: bold; font-style: italic;">PWD</span>; }

mkdir -p /tmp/foo
<span style="font-weight: bold;">cd</span> /tmp/my-very-long-thing
a vlt
<span style="font-weight: bold;">cd</span> /
vlt
<span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">PWD</span>   <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">/tmp/my-very-long-thing</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
unhist. functions can create aliases, and functions can receive
functions as parameters (as a string (function name)), so we can
combine them to advise existing functions.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">unhist</span> () {
  alias $<span style="font-weight: bold; font-style: italic;">1</span>=<span style="font-style: italic;">" $1"</span>
}
unhist unhist
unhist grep
unhist rg

<span style="font-weight: bold;">noglobber</span>() {
    alias $<span style="font-weight: bold; font-style: italic;">1</span>=<span style="font-style: italic;">"noglob $1"</span>
}
noglobber http
noglobber curl
noglobber git

</pre>
</div></li>

<li>Problem: These commands do not compose. Combination of 2 of those
doesn't work, because the second acts just on the textual
representation that it received, not the current value of the
alias.</li>
</ul>
</div>
</div>
<div id="outline-container-orge3d1992" class="outline-3">
<h3 id="orge3d1992"><span class="section-number-3">6.5</span> Override (advise?) common functions</h3>
<div class="outline-text-3" id="text-6-5">
<p>
Overriding commands is generally a bad practice as it violates the
principle of least surprise, but there might be occasions (mostly
in your local machine) where you can integrate awesome finetunnings
to your toolbelt.
</p>

<p>
Here we're going to get the original docker binary file
location. After that we declare a function called <code>docker</code> that
will proxy the parameters to the original <code>docker</code> program UNLESS
you're calling <code>docker run</code>. In that case, we're injecting a mouted
volume that mounts <code>/root/.bash_history</code> of the container to a file
hosted in the host (duh). That's a pretty cool way of keeping a
history of your recent commands in your containers, no matter how
many times you start and kill them.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">DOCKER_ORIG</span>=$(which docker)
<span style="font-weight: bold;">docker</span> () {
    <span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">1</span> == <span style="font-style: italic;">"run"</span> ]]; <span style="font-weight: bold;">then</span>
        <span style="font-weight: bold;">shift</span>
        $<span style="font-weight: bold; font-style: italic;">DOCKER_ORIG</span> run -v $<span style="font-weight: bold; font-style: italic;">HOME</span>/.shared_bash_history:/root/.bash_history <span style="font-style: italic;">"$@"</span>
    <span style="font-weight: bold;">else</span>
        $<span style="font-weight: bold; font-style: italic;">DOCKER_ORIG</span> <span style="font-style: italic;">"$@"</span>
    <span style="font-weight: bold;">fi</span>
}
</pre>
</div>

<p>
I'm particularly fond of this trick, as it saved me tons of
typing. But at a personal level, it was mindblowing that sharing
this around the internet caused the most disparity of opinions.
Also, I recently read the greate book "Docker in Practice" by <a href="https://github.com/ianmiell">Ian
Miell</a> and there's a snippet that is 99.9% like the one I
created myself. That was a very cool moment.
</p>
</div>
</div>
</div>

<div id="outline-container-org53bbe21" class="outline-2">
<h2 id="org53bbe21"><span class="section-number-2">7</span> zsh</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org54c6b5b" class="outline-3">
<h3 id="org54c6b5b"><span class="section-number-3">7.1</span> examples of global aliases</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>lspdf -tr TL P XA evince</li>
<li>docker exec -u root -ti $(docker ps -q H1) bash</li>
</ul>
</div>
</div>
<div id="outline-container-org20a3ba2" class="outline-3">
<h3 id="org20a3ba2"><span class="section-number-3">7.2</span> pass commands around</h3>
<div class="outline-text-3" id="text-7-2">
<p>
This one uses <a href="#org73ed1a7">DRY_RUN</a>. While refactoring a script that does some
curls, we want to make sure that our refactored version does the
exact same calls in the same order.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">compare_outputs</span>() {
  <span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">DRY_RUN</span>=1
  git checkout b1
  $<span style="font-weight: bold; font-style: italic;">@</span> 2&gt;/tmp/1.out
  git checkout b2
  $<span style="font-weight: bold; font-style: italic;">@</span> 2&gt;/tmp/2.out
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"diffing"</span>
  diff /tmp/1.out /tmp/2.out
}
compare_outputs ./release.sh -p rhel:6 -R <span style="font-style: italic;">'internal-preview'</span>
</pre>
</div>

<p>
First we create a function <code>compare_outputs</code>, that gets a command
to run as parameters. The function will run it once, redirecting
the standard error to a file <code>/tmp/1.out</code>.
</p>

<p>
Then, it checks out the branch that contains our refactored
version, and will run the command again, redirecting standard error
to <code>/tmp/2.out</code>, and will diff the two outputs.
</p>

<p>
In case there's a difference between the two, <code>diff</code> will output
them, and the function will return the non-zero exit value of
diff. If everything went fine, <code>compare_outputs</code> will succeed.
</p>

<p>
Now that we know that for this inputs, the command runs fine, we
want to find out if it works for other types of releases, not only
internal-preview.
</p>

<p>
Here I'm using zsh's global aliases to give a much more fluid
interface to the commands:
</p>

<div class="org-src-container">
<pre class="src src-shell">alias -g <span style="font-weight: bold; font-style: italic;">SPLIT</span>=<span style="font-style: italic;">'| tr " " "\n" '</span>
alias -g <span style="font-weight: bold; font-style: italic;">FORI</span>=<span style="font-style: italic;">'| while read i ; do '</span>
alias -g <span style="font-weight: bold; font-style: italic;">IROF</span>=<span style="font-style: italic;">'; done '</span>

<span style="font-weight: bold;">set</span> -e
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"ga internal-preview rc1 rc2"</span> SPLIT FORI
   noglob compare_outputs ./release.sh -p rhel:8 -R <span style="font-style: italic;">"$i"</span>
IROF
</pre>
</div>

<p>
So, combining the two, we can have a really smooth way of iterating
over the possibilities, without really messing into the details of
loops.
</p>

<p>
WARNING: This approach is not robust enough to put it anywhere in
production, but to write quick one off scripts is a
killer. Experimenting in a shell and creating tools and 2nd order
tools to make interaction faster builds a language that grows on
you, and keeps improving your toolbelt.
</p>
</div>
</div>


<div id="outline-container-orgb9dcaf1" class="outline-3">
<h3 id="orgb9dcaf1"><span class="section-number-3">7.3</span> suffix aliases don't have to match a filename</h3>
<div class="outline-text-3" id="text-7-3">
<p>
zsh has another type of aliases called "suffix alias". Those alias
allow you to define programs to open/run file types.
</p>
<div class="org-src-container">
<pre class="src src-shell">alias -s <span style="font-weight: bold; font-style: italic;">docx</span>=<span style="font-style: italic;">"libreoffice"</span>
</pre>
</div>

<p>
With this set, if you write a name of a file ending with <code>docx</code> as
the first token in a command line, it will use libreoffice to open
it.
</p>

<div class="org-src-container">
<pre class="src src-shell">invoice1.docx
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">will effectively call libreoffice invoice1.docx</span>
</pre>
</div>

<p>
The trick here is that the parser doesn't check that the file is
indeed an existing file. It can be any string.
</p>

<p>
Let's look at an example of it.
</p>

<div class="org-src-container">
<pre class="src src-shell">alias -s <span style="font-weight: bold; font-style: italic;">git</span>=<span style="font-style: italic;">"git clone"</span>
</pre>
</div>

<p>
In this case, we can easily copy a <code>git@github.com:.....git</code> from a
browser, and paste it into a zsh console. Then, zsh will run that
"file" with the command <code>git clone</code>, effectively cloning that
repository.
</p>

<p>
Cool, ain't it?
</p>
</div>
</div>

<div id="outline-container-org5ee6ad2" class="outline-3">
<h3 id="org5ee6ad2"><span class="section-number-3">7.4</span> noglob</h3>
<div class="outline-text-3" id="text-7-4">
<p>
zsh has more aggressive parameter expansion, to the level that
<code>[,],...</code> have special meanings, and will be interpreted and
expanded before calling the final commands in your shell.
</p>

<p>
There are commands that you don't want ever expanded , for example,
when using <code>curl</code>, it's much more likely that an open bracket will
be ment to be there verbatim rather than expanded.
</p>

<p>
Zsh provides a command to quote the following expansions. And it's
called noglob.
</p>
<div class="org-src-container">
<pre class="src src-bash">noglob curl http://example.com<span style="font-style: italic;">\&amp;</span>a[]=1
</pre>
</div>
</div>
</div>

<div id="outline-container-org13ee665" class="outline-3">
<h3 id="org13ee665"><span class="section-number-3">7.5</span> make noglob 'transparent' to bash</h3>
<div class="outline-text-3" id="text-7-5">
<p>
zsh and bash are mostly compatible, but there's a few things not
supported in bash. <code>noglob</code> is one of them. To do to layer
inbetween, an easy way is to just create a <code>~/bin/noglob</code> file
</p>
<div class="org-src-container">
<pre class="src src-bash">$<span style="font-weight: bold; font-style: italic;">*</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgc54939f" class="outline-2">
<h2 id="orgc54939f"><span class="section-number-2">8</span> debugging</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org9f1c731" class="outline-3">
<h3 id="org9f1c731"><span class="section-number-3">8.1</span> adding <code>bash</code> to a script to debug</h3>
<div class="outline-text-3" id="text-8-1">
<p>
You can add <code>bash</code> inside any script, and it will add as a
breakpoint, allowing you to check the state of the env and manually
call functions around.
</p>
</div>
</div>

<div id="outline-container-org73ed1a7" class="outline-3">
<h3 id="org73ed1a7"><span class="section-number-3">8.2</span> DRY_RUN</h3>
<div class="outline-text-3" id="text-8-2">
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">if</span> [[-n $<span style="font-weight: bold; font-style: italic;">DRY_RUN</span> ]]; <span style="font-weight: bold;">then</span>
  curl () {
    <span style="font-weight: bold;">echo</span> curl $<span style="font-weight: bold; font-style: italic;">@</span>
  }
<span style="font-weight: bold;">fi</span>
</pre>
</div>
<p>
use <code>command curl</code> to force the command, not the alias or anything
</p>
</div>
</div>
</div>

<div id="outline-container-org1a58085" class="outline-2">
<h2 id="org1a58085"><span class="section-number-2">9</span> patterns</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgce53b11" class="outline-3">
<h3 id="orgce53b11"><span class="section-number-3">9.1</span> undestand &lt;(foo) and &gt;(foo)</h3>
</div>
<div id="outline-container-org2502bab" class="outline-3">
<h3 id="org2502bab"><span class="section-number-3">9.2</span> use xargs</h3>
</div>
<div id="outline-container-org12728a1" class="outline-3">
<h3 id="org12728a1"><span class="section-number-3">9.3</span> use GNU Parallel</h3>
</div>
<div id="outline-container-org01c8db8" class="outline-3">
<h3 id="org01c8db8"><span class="section-number-3">9.4</span> append options in an array during the logic of the program</h3>
<div class="outline-text-3" id="text-9-4">
<p>
And splat them in the cli of the command you're throwing (docker run?)
</p>
</div>
</div>
<div id="outline-container-org8aa2dc9" class="outline-3">
<h3 id="org8aa2dc9"><span class="section-number-3">9.5</span> trap</h3>
<div class="outline-text-3" id="text-9-5">
<ul class="org-ul">
<li>trap "rm $variable"</li>
</ul>
</div>
</div>
<div id="outline-container-org7ae5738" class="outline-3">
<h3 id="org7ae5738"><span class="section-number-3">9.6</span> debug by introducing a 'bash'</h3>
<div class="outline-text-3" id="text-9-6">
<p>
insert <code>bash</code>
</p>
</div>
</div>
<div id="outline-container-orgdd73289" class="outline-3">
<h3 id="orgdd73289"><span class="section-number-3">9.7</span> debug with set -xa</h3>
<div class="outline-text-3" id="text-9-7">
<p>
optargs "V" option; do
case $option in
V)
  set -xa
  ;;
</p>
</div>
</div>
<div id="outline-container-org7d31c88" class="outline-3">
<h3 id="org7d31c88"><span class="section-number-3">9.8</span> structure the app like a normal app</h3>
<div class="outline-text-3" id="text-9-8">
<p>
Shellscripts are thought as quick one-off programs, but the truth
is that they tend to be useful and sticky, so you better write them
from the start as if it would be permanent.
</p>
</div>
<div id="outline-container-org7073c1c" class="outline-4">
<h4 id="org7073c1c"><span class="section-number-4">9.8.1</span> Fail Fast</h4>
<div class="outline-text-4" id="text-9-8-1">
<ul class="org-ul">
<li><a href="https://dougrichardson.us/2018/08/03/fail-fast-bash-scripting.html">https://dougrichardson.us/2018/08/03/fail-fast-bash-scripting.html</a></li>
</ul>
</div>
</div>
<div id="outline-container-org5dace12" class="outline-4">
<h4 id="org5dace12"><span class="section-number-4">9.8.2</span> Template</h4>
<div class="outline-text-4" id="text-9-8-2">
<p>
Bash is extremely permissive in what it allows to be coded and
ran. By default, failures do not make the program exit or throw an
exeption (no exceptions here).
</p>

<p>
A way to improve the defaults, is setting a bunch of flags that
make the script stricter, so it fails on many red flag situations
you'd want to stop anyway because something went wrong.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>
<span style="font-weight: bold;">set</span> -eEuo pipefail
shopt -s inherit_errexit

<span style="font-weight: bold;">main</span>() {
  parse_args()
  validate_args()
  do_things()
  cleanup()
}

main <span style="font-style: italic;">"$@"</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2ee66c1" class="outline-3">
<h3 id="org2ee66c1"><span class="section-number-3">9.9</span> make steps of the process composable</h3>
<div class="outline-text-3" id="text-9-9">
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">while</span> [[ $<span style="font-weight: bold; font-style: italic;">#</span> -gt 0 ]]; <span style="font-weight: bold;">do</span>
 <span style="font-weight: bold; font-style: italic;">key</span>=<span style="font-style: italic;">"$1"</span>
 $<span style="font-weight: bold; font-style: italic;">key</span>  <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">eval $key as a function</span>
 <span style="font-weight: bold;">shift</span>
<span style="font-weight: bold;">done</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org158184e" class="outline-3">
<h3 id="org158184e"><span class="section-number-3">9.10</span> use $@ when you can</h3>
<div class="outline-text-3" id="text-9-10">
<div class="org-src-container">
<pre class="src src-bash">
<span style="font-weight: bold;">compare_outputs</span>() {
  <span style="font-weight: bold;">export</span> <span style="font-weight: bold; font-style: italic;">DRY_RUN</span>=1
  $<span style="font-weight: bold; font-style: italic;">@</span> 2&gt;/tmp/1.out
  git checkout -
  $<span style="font-weight: bold; font-style: italic;">@</span> 2&gt;/tmp/2.out
  git checkout -
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"diffing"</span>
  diff /tmp/1.out /tmp/2.out
}

compare_outputs ./release.sh -u 1 -k 1 -p rhel:6 -v 1 -e -R <span style="font-style: italic;">'internal-preview'</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">extra tricky</span>
alias -g <span style="font-weight: bold; font-style: italic;">SPLIT</span>=<span style="font-style: italic;">'| tr " " "\n" '</span>
alias -g <span style="font-weight: bold; font-style: italic;">FORI</span>=<span style="font-style: italic;">'| while read i ; do '</span>
alias -g <span style="font-weight: bold; font-style: italic;">IROF</span>=<span style="font-style: italic;">'; done '</span>

<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"ga internal-preview rc1 rc2"</span> SPLIT FORI
  compare_outputs ./release.sh -u 1 -k 1 -p rhel:8 -v 1 -e -R <span style="font-style: italic;">"$i"</span>
IROF
</pre>
</div>
<ul class="org-ul">
<li><a href="https://www.oilshell.org/blog/2017/01/13.html">https://www.oilshell.org/blog/2017/01/13.html</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgf923348" class="outline-3">
<h3 id="orgf923348"><span class="section-number-3">9.11</span> source files</h3>
<div class="outline-text-3" id="text-9-11">
<p>
<code>source</code> is like <code>require</code> in most programming languages. It
evaluates the sourced file in the context of the currently
evaluated script.
</p>

<p>
It's simple, but get used to modularize your code into libraries.
</p>

<p>
Be careful, it's very rudimentary, and it will be overwriting old
vars or functions if names clash. There's no namespacing happening
there.
</p>

<div class="org-src-container">
<pre class="src src-bash">
source file.sh

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">the same</span>
. file.sh
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf3db497" class="outline-3">
<h3 id="orgf3db497"><span class="section-number-3">9.12</span> Dots and colons allowed in function names!</h3>
<div class="outline-text-3" id="text-9-12">
<p>
A way to split the namespace is to have libs define functions with
their own namespace.
</p>

<p>
I've gotten used to use dots or colons as namespace separator.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">semver.greater</span>() {
 <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
}
</pre>
</div>
<p>
or
</p>
<div class="org-src-container">
<pre class="src src-bash">semver:greater() {
 <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org5860b71" class="outline-3">
<h3 id="org5860b71"><span class="section-number-3">9.13</span> Use Scripts as a Libs</h3>
<div class="outline-text-3" id="text-9-13">
<p>
A python-inspired way of using scripts as loadable libraries is to
check whether the current file was the one that was called
originally or it's being just sourced.
</p>

<p>
Again, no side effects in load time makes this functionality
possible. otherwise, you're on your own.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Allow sourcing of this script</span>
<span style="font-weight: bold;">if</span> [[ $(basename <span style="font-style: italic;">"$(realpath "$0")"</span>) == <span style="font-style: italic;">"package.sh"</span> ]]; <span style="font-weight: bold;">then</span>
  setup
  parse_args <span style="font-style: italic;">"$@"</span>
  main
<span style="font-weight: bold;">fi</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf50726b" class="outline-3">
<h3 id="orgf50726b"><span class="section-number-3">9.14</span> Use tempfiles everywhere</h3>
<div class="outline-text-3" id="text-9-14">
<p>
Your script is not going to run alone. Don't assume paths are
fixed or known.
</p>

<p>
CI/CD Pipelines run many jobs in the same node and files can start
clashing.
</p>

<p>
Make use of <code>$(mktemp /tmp/foo-bar.XXXXX)</code>.
</p>
</div>
</div>
<div id="outline-container-orgd513113" class="outline-3">
<h3 id="orgd513113"><span class="section-number-3">9.15</span> Use tempdirs everywhere</h3>
<div class="outline-text-3" id="text-9-15">
<p>
Your script is not going to run alone. Don't assume paths are
fixed or known.
</p>

<p>
CI/CD Pipelines run many jobs in the same node and files can start
clashing.
</p>

<p>
Make use of <code>$(mktemp -d /tmp/foo-bar.XXXXX)</code>.  If you have to patch a
file, do it in a clean fresh copy. Don't modify files in old paths
</p>

<p>
If you HAVE TO modify paths, do it idempotently.  But really, don't do it. aa
</p>

<p>
CAVEAT: You have to manually delete the directory if you want it cleaned.
</p>
</div>
</div>
<div id="outline-container-org265026e" class="outline-3">
<h3 id="org265026e"><span class="section-number-3">9.16</span> Cleanup tasks with trap</h3>
<div class="outline-text-3" id="text-9-16">
<p>
<code>trap</code> is used to 'subscribe' a callback when something happens.
Many times it's used on exit. It's a good thing to cleanup tmpdirs after your script
exits, so you can use the output of <code>mktemp -d</code> and subscribe a cleanup
function for it.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">on_exit</span>() {
  rm -rf $<span style="font-weight: bold; font-style: italic;">1</span>
}

<span style="font-weight: bold;">trap</span> <span style="font-style: italic;">"on_exit $(mktemp -d /tmp/foo-bar.XXXXX)"</span> EXIT SIGINT
</pre>
</div>
</div>
</div>

<div id="outline-container-orge052379" class="outline-3">
<h3 id="orge052379"><span class="section-number-3">9.17</span> array of callbacks on_exit</h3>
<div class="outline-text-3" id="text-9-17">
<p>
Level upping that pattern, we can have a helper to add callbacks to run on exit.
</p>

<div class="org-src-container">
<pre class="src src-bash">
<span style="font-weight: bold; font-style: italic;">ON_EXIT</span>=()
<span style="font-weight: bold; font-style: italic;">EXIT_RES</span>=

<span style="font-weight: bold;">function</span> <span style="font-weight: bold;">on_exit_fn</span> {
  <span style="font-weight: bold; font-style: italic;">EXIT_RES</span>=$<span style="font-weight: bold; font-style: italic;">?</span>
  <span style="font-weight: bold;">for</span> cb<span style="font-weight: bold;"> in</span> <span style="font-style: italic;">"${ON_EXIT[@]}"</span>; <span style="font-weight: bold;">do</span> $<span style="font-weight: bold; font-style: italic;">cb</span> || true; <span style="font-weight: bold;">done</span>
  <span style="font-weight: bold;">return</span> $<span style="font-weight: bold; font-style: italic;">EXIT_RES</span>
}

<span style="font-weight: bold;">trap</span> on_exit_fn EXIT SIGINT

<span style="font-weight: bold;">function</span> <span style="font-weight: bold;">on_exit</span> {
  ON_EXIT+=(<span style="font-style: italic;">"$@"</span>)
}

</pre>
</div>
</div>
</div>
<div id="outline-container-org4ee1e05" class="outline-3">
<h3 id="org4ee1e05"><span class="section-number-3">9.18</span> pass flags as a splatted array</h3>
</div>
<div id="outline-container-org061229b" class="outline-3">
<h3 id="org061229b"><span class="section-number-3">9.19</span> explore what passes through a pipe with</h3>
<div class="outline-text-3" id="text-9-19">
<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/17983777/shell-pipe-to-multiple-commands-in-a-file">https://stackoverflow.com/questions/17983777/shell-pipe-to-multiple-commands-in-a-file</a></li>
</ul>
<p>
tee &gt;(some_command) |
</p>
</div>
</div>
<div id="outline-container-org87b84a1" class="outline-3">
<h3 id="org87b84a1"><span class="section-number-3">9.20</span> inherit_errcode</h3>
</div>
<div id="outline-container-org225c52f" class="outline-3">
<h3 id="org225c52f"><span class="section-number-3">9.21</span> redirects</h3>
<div class="outline-text-3" id="text-9-21">
<ul class="org-ul">
<li><a href="https://catonmat.net/ftp/bash-redirections-cheat-sheet.pdf">https://catonmat.net/ftp/bash-redirections-cheat-sheet.pdf</a></li>
<li><a href="https://catonmat.net/bash-one-liners-explained-part-three">https://catonmat.net/bash-one-liners-explained-part-three</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgf777f16" class="outline-3">
<h3 id="orgf777f16"><span class="section-number-3">9.22</span> pushd/popd</h3>
<div class="outline-text-3" id="text-9-22">
<p>
pushd and popd are used to move to some directory and go back to it
in a stack fashion, so nesting can happen and you never lose track.
</p>
<div class="org-src-container">
<pre class="src src-bash">pushd /tmp/my-dir
  <span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">PWD</span>
popd
</pre>
</div>

<p>
Here's an alternative way, that at least makes sure that you close
all pushd with a popd.
</p>

<p>
Starting a new shell and cd-ing , will make all commands in that
subshell be in that directory, and will come back to the old
directory after closing the new spawned shell.
</p>

<div class="org-src-container">
<pre class="src src-bash">(<span style="font-weight: bold;">cd</span> /tmp/my-dir
  ls
)
</pre>
</div>
</div>
</div>
<div id="outline-container-org02052a9" class="outline-3">
<h3 id="org02052a9"><span class="section-number-3">9.23</span> wrap functions</h3>
<div class="outline-text-3" id="text-9-23">
<p>
Bash can't pass blocks of code around, but the alternative is to
pass functions.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">mute</span>() {
  $<span style="font-weight: bold; font-style: italic;">@</span> &gt;/dev/null
}

mute ls
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga3f2e57" class="outline-2">
<h2 id="orga3f2e57"><span class="section-number-2">10</span> links</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li><a href="https://mywiki.wooledge.org/BashPitfalls">https://mywiki.wooledge.org/BashPitfalls</a></li>
<li><a href="https://tldp.org/LDP/abs/html/">https://tldp.org/LDP/abs/html/</a></li>
<li>Gary Bernhardt. The Unix Chainsaw</li>
<li><a href="https://news.ycombinator.com/item?id=23765123">https://news.ycombinator.com/item?id=23765123</a></li>
<li><a href="https://medium.com/@joydeepubuntu/functional-programming-in-bash-145b6db336b7">https://medium.com/@joydeepubuntu/functional-programming-in-bash-145b6db336b7</a></li>
<li><a href="https://www.youtube.com/watch?v=yD2ekOEP9sU">https://www.youtube.com/watch?v=yD2ekOEP9sU</a></li>
<li><a href="http://catern.com/posts/pipes.html">http://catern.com/posts/pipes.html</a></li>
<li><a href="https://ebzzry.io/en/zsh-tips-1/">https://ebzzry.io/en/zsh-tips-1/</a></li>
<li><a href="https://github.com/ssledz/bash-fun">https://github.com/ssledz/bash-fun</a></li>
</ul>
</div>
</div>
<div id="outline-container-orge01154a" class="outline-2">
<h2 id="orge01154a"><span class="section-number-2">11</span> from shell to lisp and everything in between</h2>
<div class="outline-text-2" id="text-11">
<ul class="org-ul">
<li><a href="https://github.com/oilshell/oil">https://github.com/oilshell/oil</a></li>
<li><a href="https://www.eigenbahn.com/2020/07/08/painless-emacs-remote-shells">https://www.eigenbahn.com/2020/07/08/painless-emacs-remote-shells</a></li>
<li><a href="https://news.ycombinator.com/item?id=24249646">https://news.ycombinator.com/item?id=24249646</a> rust</li>
<li>spencertipping @github</li>
<li>rash (racket shell)</li>
<li>zsh</li>
<li><a href="https://github.com/liljencrantz/crush">https://github.com/liljencrantz/crush</a></li>
<li><a href="https://github.com/artyom-poptsov/metabash">https://github.com/artyom-poptsov/metabash</a></li>
<li>perl/python/ruby and migrate from bash to X using backticks</li>
<li><a href="https://www.nushell.sh/">https://www.nushell.sh/</a></li>
<li>bocker</li>
</ul>
</div>
</div>
<div id="outline-container-orgba41eed" class="outline-2">
<h2 id="orgba41eed"><span class="section-number-2">12</span> make scripts compatible between them</h2>
<div class="outline-text-2" id="text-12">
</div>
<div id="outline-container-orge574e3f" class="outline-3">
<h3 id="orge574e3f"><span class="section-number-3">12.1</span> create scripts that replace shell commands and do the same.</h3>
<div class="outline-text-3" id="text-12-1">
<p>
to be able to run a zsh script with noglobs in bash, here's
<code>~/bin/noglob</code>.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/</span><span style="font-weight: bold;">env</span><span style="font-weight: bold; font-style: italic;"> bash</span>
$<span style="font-weight: bold; font-style: italic;">*</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Raimon Grau</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.1 (<a href="https://orgmode.org">Org</a> mode 9.1.9)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
