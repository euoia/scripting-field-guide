<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shell Field Guide</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Raimon Grau" />
<meta name="keywords" content="bash zsh shell" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Shell Field Guide</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd2c8804">1. Introduction</a></li>
<li><a href="#org38325f3">2. shell</a></li>
<li><a href="#org2282ab5">3. Level</a></li>
<li><a href="#orgadda197">4. bash</a>
<ul>
<li><a href="#org9a0461d">4.1. Use Shellcheck</a></li>
<li><a href="#org47cd40f">4.2. use [[</a></li>
<li><a href="#org8042a4e">4.3. eval?</a></li>
</ul>
</li>
<li><a href="#org1ff925d">5. Basics</a>
<ul>
<li><a href="#orgb260ef3">5.1. Overview</a></li>
<li><a href="#org9b4324e">5.2. Booleans and Conditionals</a></li>
<li><a href="#org43f1a97">5.3. Functions</a></li>
<li><a href="#org1961f0d">5.4. Variables</a></li>
<li><a href="#orgf80bd07">5.5. Interpolation</a></li>
<li><a href="#orgdf9a501">5.6. dispatch functions using args</a></li>
<li><a href="#org5ff6893">5.7. command_not_found_handle</a></li>
<li><a href="#org2d8c302">5.8. Return Values for Conditionals</a></li>
<li><a href="#orge7ffcf8">5.9. Do work on loop conditions</a></li>
<li><a href="#org5e10add">5.10. One Branch Conditionals</a></li>
</ul>
</li>
<li><a href="#org7d74044">6. interactive</a>
<ul>
<li><a href="#org9749700">6.1. Save your small scripts</a></li>
<li><a href="#orgddaf5c8">6.2. Increased Interactivity</a></li>
<li><a href="#org8725a22">6.3. Aliases</a></li>
<li><a href="#org9a97aeb">6.4. functions can generate aliases</a></li>
<li><a href="#orgfaab414">6.5. Override (advise?) common functions</a></li>
</ul>
</li>
<li><a href="#org65fc096">7. links</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd2c8804" class="outline-2">
<h2 id="orgd2c8804"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This booklet is intended to be a catalog of tricks and techniques
you should be using if you're doing any sort of scripting. I'll try
to keep the rethoric to the very minimal because that way you can
enjoy the content in less time.
</p>

<p>
You probably have some amount of sh/bash/zsh in your stack that
probably started as 1 off scripts, and probably later on started
growing and being copypasted everywhere in your pipelines, or your
coworkers use for their own use (with some variations), etc. Those
scripts are very difficult to kill and they have a very high
mutation rate.
</p>
</div>
</div>
<div id="outline-container-org38325f3" class="outline-2">
<h2 id="org38325f3"><span class="section-number-2">2</span> shell</h2>
<div class="outline-text-2" id="text-2">
<p>
No matter if you use Linux, Mac, or Win, you should be living most
of the time in a shell to enjoy the content shown here. Some value
comes from the automated scripts, and some comes from the daily
usage and refinement of your helper functions, aliases, etc.
</p>

<p>
In general the examples here are ment to run in Bash or Zsh, which
are compatible for the most part.
</p>
</div>
</div>
<div id="outline-container-org2282ab5" class="outline-2">
<h2 id="org2282ab5"><span class="section-number-2">3</span> Level</h2>
<div class="outline-text-2" id="text-3">
<p>
These examples are based on non-trivial real world code I've written
that I haven't seen applied in many places over the net. Some of the
snippets are stolen from public repos.
</p>
</div>
</div>
<div id="outline-container-orgadda197" class="outline-2">
<h2 id="orgadda197"><span class="section-number-2">4</span> bash</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org9a0461d" class="outline-3">
<h3 id="org9a0461d"><span class="section-number-3">4.1</span> Use Shellcheck</h3>
<div class="outline-text-3" id="text-4-1">
<p>
First, let's get that out of the way. This is low hanging
fruit. And you will get the most of this booklet by following it.
</p>

<p>
A lot of the most common errors we usually make are well known
ones. And in fact, we all usually fail in similar ways. Bash is
known for being error prone when dealing with testing variable
values, string operations, or flaky subshells and pipes.
</p>

<p>
Installing <a href="https://www.shellcheck.net/">shellcheck</a> will flag you many of those ticking bombs.
</p>

<p>
No matter which editor you are using, but you should be able to
install a plugin to do automatic checks while you're editing.
</p>

<p>
In emacs' case, the package is called <a href="https://github.com/federicotdn/flymake-shellcheck">flymake-shellcheck</a>, and a
quick configuration for it is:
</p>

<div class="org-src-container">
<pre class="src src-elisp">(use-package flymake-shellcheck
  <span style="font-weight: bold;">:ensure</span> t
  <span style="font-weight: bold;">:commands</span> flymake-shellcheck-load
  <span style="font-weight: bold;">:init</span>
  (add-hook 'sh-mode-hook 'flymake-shellcheck-load))
</pre>
</div>

<p>
Shellcheck is available on most distros, so it's just an <code>apt</code>,
<code>brew</code>, or <code>nix-env</code> away.
</p>
</div>
</div>

<div id="outline-container-org47cd40f" class="outline-3">
<h3 id="org47cd40f"><span class="section-number-3">4.2</span> use [[</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Unless you want your script to be POSIX compliant, use <code>[[</code> instead
of <code>[</code>. <code>[</code> is a regular command. It's like <code>ls</code>, or <code>true</code>. You can
check it by searching for a file named <code>[</code> in your path.
</p>

<p>
Being a normal command it always evaluates its params, like a
regular function. On the other hand though, <code>[[</code> is a special bash
operator, and it evaluates the parameters lazily.
</p>

<div class="org-src-container">
<pre class="src src-bash">
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">[[ does lazy evaluation:</span>
[[ a = b &amp;&amp; $(<span style="font-weight: bold;">echo</span> foo &gt;&amp;2) ]]

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">[ does not:</span>
[ a = b -a <span style="font-style: italic;">"$(echo foo &gt;&amp;2)&#8221; ]</span>
</pre>
</div>
<p>
Ref: <a href="https://lists.gnu.org/archive/html/help-bash/2014-06/msg00013.html">https://lists.gnu.org/archive/html/help-bash/2014-06/msg00013.html</a>
</p>
</div>
</div>

<div id="outline-container-org8042a4e" class="outline-3">
<h3 id="org8042a4e"><span class="section-number-3">4.3</span> eval?</h3>
<div class="outline-text-3" id="text-4-3">
<p>
When you have mostly small functions that are mostly pure, you
compose them like you'd do in any other language.
</p>

<p>
In the following snippet, we are in a release script. Some step
builds a package inside an image, another step tests a package
already built.
</p>

<p>
A nice way to build ubuntus, for example, is to add an ARG to the
Dockerfile so we can build several ubuntu versions using the same
file.
</p>

<p>
It'd look something like this:
</p>
<div class="org-src-container">
<pre class="src src-Dockerfile">ARG VERSION
FROM ubuntu:$VERSION

RUN apt-get ...
...
</pre>
</div>

<p>
We build that image and do all the building inside it, mounting a
volume shared with our host, so we can extract our <code>.deb</code> file
easily.
</p>

<p>
After that, you probably want to do some smoke tests on the
package, so the idea would be to install the <code>.deb</code> file in a fresh
ubuntu image.
</p>

<p>
Let's pick the same base image we picked to build the package.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">evaluate the string "centos:$VERSION" (that comes from</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">centos/Dockerfile) in the current scope</span>
local <span style="font-weight: bold; font-style: italic;">VERSION</span>=$(get_version $<span style="font-weight: bold; font-style: italic;">DISTRO</span>)
run_tests <span style="font-style: italic;">"$PACKAGE_PATH"</span> <span style="font-style: italic;">"$(eval echo $(awk '/^FROM /{print $2; exit}' $LOCAL_PATH/$(get_dockerfile_for $DISTRO)))"</span>
</pre>
</div>

<p>
The usage of eval is there to interpolate the string that we get
from the <code>FROM</code> in the current environment.
</p>

<p>
WARNING: You know, anything that uses <code>eval</code> is dangerous per
se. Do not use it unless you know very well what you're doing AND
the input is 100% under your control. Usually, more restricted
commands can achieve what you want to do. In this particular case,
you could use <code>envsubst</code>, or just manually replace <code>$\{?VERSION\}?</code>
in a sed.
</p>

<div class="org-src-container">
<pre class="src src-bash">test_release <span style="font-style: italic;">"$PACKAGE_PATH"</span> $(awk <span style="font-style: italic;">'/^FROM /{print $2; exit}'</span> $<span style="font-weight: bold; font-style: italic;">LOCAL_PATH</span>/$(get_dockerfile_for $<span style="font-weight: bold; font-style: italic;">DISTRO</span>) | sed -e <span style="font-style: italic;">"s/\$VERSION/$VERSION/"</span>)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1ff925d" class="outline-2">
<h2 id="org1ff925d"><span class="section-number-2">5</span> Basics</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-orgb260ef3" class="outline-3">
<h3 id="orgb260ef3"><span class="section-number-3">5.1</span> Overview</h3>
<div class="outline-text-3" id="text-5-1">
<p>
In this section, we're covering the parts of the basics that are
not so basic after all, or that are more unique in shellscripting
languages.
</p>
</div>
</div>

<div id="outline-container-org9b4324e" class="outline-3">
<h3 id="org9b4324e"><span class="section-number-3">5.2</span> Booleans and Conditionals</h3>
<div class="outline-text-3" id="text-5-2">
<p>
In any shell, <code>foo &amp;&amp; bar</code> will execute <code>bar</code> only if <code>foo</code>
succeeded. That means that <code>foo</code> returned 0. That means that to &amp;&amp;
(which you read like "and"), 0 is true. so yes. 0 is true, and
other values are false.
</p>
</div>
</div>

<div id="outline-container-org43f1a97" class="outline-3">
<h3 id="org43f1a97"><span class="section-number-3">5.3</span> Functions</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Functions are functions. They receive arguments, and they return a
value.
</p>

<p>
The special thing about functions in shell is that they also can use
the file descriptors of the process. That means that they "inherit"
STDIN, STDOUT, STDERR (and maybe more).
</p>

<p>
Use them.
</p>

<p>
Another point is that function names can be passed as parameters,
because they are passed as strings, but you can call them inside as
functions again.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">f</span>() {
  $<span style="font-weight: bold; font-style: italic;">1</span> hi
}

f echo
f touch <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">will create a file 'hi'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1961f0d" class="outline-3">
<h3 id="org1961f0d"><span class="section-number-3">5.4</span> Variables</h3>
<div class="outline-text-3" id="text-5-4">
<p>
By default variables are global, to a file. No matter if you assign
them for the first time inside a function, or at the top leve.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">foo</span>=3
<span style="font-weight: bold; font-style: italic;">bar</span>=$<span style="font-weight: bold; font-style: italic;">foo</span>
<span style="font-weight: bold;">f</span>() {
  <span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">foo</span>
}
f
</pre>
</div>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">f</span>() {
  <span style="font-weight: bold; font-style: italic;">bar</span>=1
}
f
<span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">bar</span>
</pre>
</div>

<p>
You make a variable local to a function with <code>local</code>. Use it as
much as you can (kinda obvious).
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">myfun</span>() {
  local bar
  <span style="font-weight: bold; font-style: italic;">bar</span>=3
  <span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">bar</span>
}

<span style="font-weight: bold; font-style: italic;">bar</span>=4
<span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">bar</span>
myfun
<span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">bar</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf80bd07" class="outline-3">
<h3 id="orgf80bd07"><span class="section-number-3">5.5</span> Interpolation</h3>
<div class="outline-text-3" id="text-5-5">
<p>
We previously saw that functions can be passed around as strings,
and be called later on.
</p>

<p>
Something that might not be obvious is that the string can be
created from shorter strings, and that allows for an extra
flexibility, that comes with its own dangers, but it's a very
useful pattern to dispatch functions based on user input or
function outputs.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">l</span>=l
<span style="font-weight: bold; font-style: italic;">s</span>=s
$<span style="font-weight: bold; font-style: italic;">l</span>$<span style="font-weight: bold; font-style: italic;">s</span> .
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdf9a501" class="outline-3">
<h3 id="orgdf9a501"><span class="section-number-3">5.6</span> dispatch functions using args</h3>
<div class="outline-text-3" id="text-5-6">
<p>
A nice usage of the previous technique is using user's input as a
dispatching method.
</p>

<p>
You've probably seen this pattern already:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">while</span> [[ $<span style="font-weight: bold; font-style: italic;">#</span> -gt 0 ]]; <span style="font-weight: bold;">do</span>

<span style="font-weight: bold;">case</span> $<span style="font-weight: bold; font-style: italic;">1</span><span style="font-weight: bold;"> in</span>
  foo)
    foo
    ;;
  *)
    <span style="font-weight: bold;">exit</span> 1
    ;;
<span style="font-weight: bold;">esac</span>
<span style="font-weight: bold;">shift</span>
<span style="font-weight: bold;">done</span>
</pre>
</div>

<p>
And it is useful for its own good, and flexible.
</p>

<p>
But for some simpler cases, we can dispatch based on the variable
itself:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">cmd_foo</span>() {
 do-something
}

cmd_$<span style="font-weight: bold; font-style: italic;">1</span>
</pre>
</div>

<p>
The problem with this is that in case we supply a <code>$1</code> that doesn't
map to any <code>cmd_$1</code> we'll get something like
</p>

<div class="org-src-container">
<pre class="src src-bash">bash: cmd_notexisting: command not found
</pre>
</div>
</div>
</div>

<div id="outline-container-org5ff6893" class="outline-3">
<h3 id="org5ff6893"><span class="section-number-3">5.7</span> command_not_found_handle</h3>
<div class="outline-text-3" id="text-5-7">
<p>
Here's a detail on a kinda obscure bash (only bash) feature.
</p>

<p>
You can set a hook that will be called when bash tries to run a
command and it doesn't find it.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">command_not_found_handle</span>() {
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"$1 is not a correct command. Cmds allowed:"</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"$(typeset -F | grep cmd_ | sed -e 's/.*cmd_/cmd_/')"</span>
}

<span style="font-weight: bold;">cmd_foo</span>() {
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"foo"</span>
}

<span style="font-weight: bold;">cmd_baz</span>() {
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"baz"</span>
}
cmd_bar
</pre>
</div>

<p>
you can unset the function <code>command_not_found_handle</code> to go back to
the normal behavior.
</p>
</div>
</div>


<div id="outline-container-org2d8c302" class="outline-3">
<h3 id="org2d8c302"><span class="section-number-3">5.8</span> Return Values for Conditionals</h3>
<div class="outline-text-3" id="text-5-8">
<p>
<code>if</code> 's conditions can be bound to the return values of
commands. That's a known thing, but lots of code you see around
rely on <code>[[]]=</code> to test the return values of commands/functions
anyway.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">if </span><span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"foo"</span> | grep <span style="font-style: italic;">"bar"</span> ; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"found!"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>

<p>
This is much clearer than
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">if</span> [[ ! -z $( <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"foo"</span> | grep <span style="font-style: italic;">"bar"</span>) ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"found!"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>

<p>
As easy and trivial as it seems, this way of thinking pushes you
forward to thinking on creating smaller functions that check the
conditions and <code>return</code> 0 or non 0. It's syntactically smaller, and
usually makes you play by the rules of the commands, more than just
finding your way around the output strings.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">if</span> less_than $<span style="font-weight: bold; font-style: italic;">package</span> <span style="font-style: italic;">"1.3.2"</span>; <span style="font-weight: bold;">then</span>
  die <span style="font-style: italic;">"can't proceed"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge7ffcf8" class="outline-3">
<h3 id="orge7ffcf8"><span class="section-number-3">5.9</span> Do work on loop conditions</h3>
<div class="outline-text-3" id="text-5-9">
<p>
Although not commonly seen used (and there might be a reason for
it, who knows), <code>while</code> conditions are just plain commands, so you
can put other stuff than <code>[]</code> tests there.
</p>

<p>
Heres's an idiomatic way to iterate through all the arguments of a
function while consuming the <code>$*</code> array.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">while</span>(($<span style="font-weight: bold; font-style: italic;">#</span>)) ; <span style="font-weight: bold;">do</span>
  <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">...</span>
  <span style="font-weight: bold;">shift</span>
<span style="font-weight: bold;">done</span>
</pre>
</div>

<p>
And here's a pseudo-repl that keeps shooting one-off commands. This
will keep shooting <code>tr</code> commands to whatever strings you give it,
with the usual rlwrap goodies.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">while</span> rlwrap -o -S<span style="font-style: italic;">'&gt;&gt; '</span> tr a-z A-Z ; <span style="font-weight: bold;">do</span> :; <span style="font-weight: bold;">done</span>
</pre>
</div>

<p>
Note: <code>:</code> is a nop builtin in bash.
</p>
</div>
</div>
<div id="outline-container-org5e10add" class="outline-3">
<h3 id="org5e10add"><span class="section-number-3">5.10</span> One Branch Conditionals</h3>
<div class="outline-text-3" id="text-5-10">
<p>
The usual conditionals one sees everywhere look like <code>if</code>.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">if</span> [[ some-condition ]]; <span style="font-weight: bold;">then</span>
  <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"yes"</span>
<span style="font-weight: bold;">fi</span>
</pre>
</div>

<p>
This is all good and fine, but in the same vein of using the least
powerful construct for each task, it's nice to think of the one way
conditionals in the form of <code>&amp;&amp;</code> and <code>||</code> as a way to explicitly
say that we don't want to do anything else when the condition is
not met. It's a hint to the reader.
</p>

<div class="org-src-container">
<pre class="src src-bash">some-condition || {
   <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"log: warning!"</span>
}

other-condition &amp;&amp; {
   <span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"log: all cool"</span>
}
</pre>
</div>

<p>
This conveys the desire of doing something <b>just</b> in one case, and
that the negation of this is not interesting at all.
</p>

<p>
There are lots of references to this, but I like this recent post
where it explains it for arrays in higher level languages like ruby:
<a href="https://jesseduffield.com/array-functions-and-the-rule-of-least-power/">https://jesseduffield.com/array-functions-and-the-rule-of-least-power/</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org7d74044" class="outline-2">
<h2 id="org7d74044"><span class="section-number-2">6</span> interactive</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org9749700" class="outline-3">
<h3 id="org9749700"><span class="section-number-3">6.1</span> Save your small scripts</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Rome wasn't built in a day, and like having a journal log, most of
the little scripts you create, once you have enough discipline will
be useful for some other cases, and your functions will be
reusable.
</p>

<p>
Save your scripts into files early on, instead of crunching
everything in the repl. learn how to use a decent editor that
shortens the feedback cycle as much as possible.
</p>
</div>
</div>

<div id="outline-container-orgddaf5c8" class="outline-3">
<h3 id="orgddaf5c8"><span class="section-number-3">6.2</span> Increased Interactivity</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Knowing your shell's shortcuts for interactive use is a must. The
same way you learned to touchtype and you learned your editor, you
should learn all the shortcuts for your shell. Here's some simple
ones.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">key</th>
<th scope="col" class="org-left">action</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">ctrl-r</td>
<td class="org-left">reverse-history-search</td>
</tr>

<tr>
<td class="org-left">c-a</td>
<td class="org-left">beginning-of-line</td>
</tr>

<tr>
<td class="org-left">c-e</td>
<td class="org-left">end-of-line</td>
</tr>

<tr>
<td class="org-left">c-w</td>
<td class="org-left">delete-word-backwards</td>
</tr>

<tr>
<td class="org-left">c-k</td>
<td class="org-left">kill-line (from point to eol)</td>
</tr>

<tr>
<td class="org-left">c-p</td>
<td class="org-left">previous-line</td>
</tr>

<tr>
<td class="org-left">c-n</td>
<td class="org-left">next-line</td>
</tr>

<tr>
<td class="org-left">a-.</td>
<td class="org-left">insert last agument</td>
</tr>

<tr>
<td class="org-left">a-/</td>
<td class="org-left">dabbrev-expand</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org8725a22" class="outline-3">
<h3 id="org8725a22"><span class="section-number-3">6.3</span> Aliases</h3>
<div class="outline-text-3" id="text-6-3">
<p>
Aliases are very simple substitutions of commands for a sequence of
other commands.  Usual example is
</p>

<div class="org-src-container">
<pre class="src src-bash">alias <span style="font-weight: bold; font-style: italic;">ls</span>=<span style="font-style: italic;">'ls --auto-color'</span>
</pre>
</div>

<p>
Now let's move on to the interesting stuff.
</p>
</div>
</div>

<div id="outline-container-org9a97aeb" class="outline-3">
<h3 id="org9a97aeb"><span class="section-number-3">6.4</span> functions can generate aliases</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Aliases live in a global namespace for the shell, so no matter
where you define them, they take effect globally, possibly
overwriting older aliases with the same name.
</p>

<p>
Well, it's not lexical scope (far from it), but using aliases you
can create a string that snapshots the value you want, and capture
it to run it later.
</p>

<p>
Some fun stuff:
</p>

<ul class="org-ul">
<li>aliasgen. Create an alias for each directory in
~/workspace/. This is superceeded by <code>CDPATH</code>, but the trick is
still cool.</li>
</ul>
<div class="org-src-container">
<pre class="src src-zsh">aliasgen() {
  for i in ~/workspace/*(/) ; do
      DIR=$(basename $i) ;
       alias $DIR="cd ~/workspace/$i";
  done
}
aliasgen
</pre>
</div>

<ul class="org-ul">
<li>a make a shortcut to the current directory.</li>
</ul>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">function</span> <span style="font-weight: bold;">a</span>() { alias $<span style="font-weight: bold; font-style: italic;">1</span>=cd<span style="font-style: italic;">\ </span>$<span style="font-weight: bold; font-style: italic;">PWD</span>; }

mkdir -p /tmp/foo
<span style="font-weight: bold;">cd</span> /tmp/my-very-long-thing
a vlt
<span style="font-weight: bold;">cd</span> /
vlt
<span style="font-weight: bold;">echo</span> $<span style="font-weight: bold; font-style: italic;">PWD</span>   <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">/tmp/my-very-long-thing</span>
</pre>
</div>

<ul class="org-ul">
<li><p>
unhist. functions can create aliases, and functions can receive
functions as parameters (as a string (function name)), so we can
combine them to advise existing functions.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">unhist</span> () {
  alias $<span style="font-weight: bold; font-style: italic;">1</span>=<span style="font-style: italic;">" $1"</span>
}
unhist unhist
unhist grep
unhist rg

<span style="font-weight: bold;">noglobber</span>() {
    alias $<span style="font-weight: bold; font-style: italic;">1</span>=<span style="font-style: italic;">"noglob $1"</span>
}
noglobber http
noglobber curl
noglobber git

</pre>
</div></li>

<li>Problem: These commands do not compose. Combination of 2 of those
doesn't work, because the second acts just on the textual
representation that it received, not the current value of the
alias.</li>
</ul>
</div>
</div>
<div id="outline-container-orgfaab414" class="outline-3">
<h3 id="orgfaab414"><span class="section-number-3">6.5</span> Override (advise?) common functions</h3>
<div class="outline-text-3" id="text-6-5">
<p>
Overriding commands is generally a bad practice as it violates the
principle of least surprise, but there might be occasions (mostly
in your local machine) where you can integrate awesome finetunnings
to your toolbelt.
</p>

<p>
Here we're going to get the original docker binary file
location. After that we declare a function called <code>docker</code> that
will proxy the parameters to the original <code>docker</code> program UNLESS
you're calling <code>docker run</code>. In that case, we're injecting a mouted
volume that mounts <code>/root/.bash_history</code> of the container to a file
hosted in the host (duh). That's a pretty cool way of keeping a
history of your recent commands in your containers, no matter how
many times you start and kill them.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;">DOCKER_ORIG</span>=$(which docker)
<span style="font-weight: bold;">docker</span> () {
    <span style="font-weight: bold;">if</span> [[ $<span style="font-weight: bold; font-style: italic;">1</span> == <span style="font-style: italic;">"run"</span> ]]; <span style="font-weight: bold;">then</span>
        <span style="font-weight: bold;">shift</span>
        $<span style="font-weight: bold; font-style: italic;">DOCKER_ORIG</span> run -v $<span style="font-weight: bold; font-style: italic;">HOME</span>/.shared_bash_history:/root/.bash_history <span style="font-style: italic;">"$@"</span>
    <span style="font-weight: bold;">else</span>
        $<span style="font-weight: bold; font-style: italic;">DOCKER_ORIG</span> <span style="font-style: italic;">"$@"</span>
    <span style="font-weight: bold;">fi</span>
}
</pre>
</div>

<p>
I'm particularly fond of this trick, as it saved me tons of
typing. But at a personal level, it was mindblowing that sharing
this around the internet caused the most disparity of opinions.
Also, I recently read the greate book "Docker in Practice" by <a href="https://github.com/ianmiell">Ian
Miell</a> and there's a snippet that is 99.9% like the one I
created myself. That was a very cool moment.
</p>
</div>
</div>
</div>

<div id="outline-container-org65fc096" class="outline-2">
<h2 id="org65fc096"><span class="section-number-2">7</span> links</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li><a href="https://mywiki.wooledge.org/BashPitfalls">https://mywiki.wooledge.org/BashPitfalls</a></li>
<li><a href="https://tldp.org/LDP/abs/html/">https://tldp.org/LDP/abs/html/</a></li>
<li>Gary Bernhardt. The Unix Chainsaw</li>
<li><a href="https://news.ycombinator.com/item?id=23765123">https://news.ycombinator.com/item?id=23765123</a></li>
<li><a href="https://medium.com/@joydeepubuntu/functional-programming-in-bash-145b6db336b7">https://medium.com/@joydeepubuntu/functional-programming-in-bash-145b6db336b7</a></li>
<li><a href="https://www.youtube.com/watch?v=yD2ekOEP9sU">https://www.youtube.com/watch?v=yD2ekOEP9sU</a></li>
<li><a href="http://catern.com/posts/pipes.html">http://catern.com/posts/pipes.html</a></li>
<li><a href="https://ebzzry.io/en/zsh-tips-1/">https://ebzzry.io/en/zsh-tips-1/</a></li>
<li><a href="https://github.com/ssledz/bash-fun">https://github.com/ssledz/bash-fun</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Raimon Grau</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.1 (<a href="https://orgmode.org">Org</a> mode 9.1.9)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
